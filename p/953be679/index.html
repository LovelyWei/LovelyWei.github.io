<!DOCTYPE html>
<html style="display: none;" lang="en">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.5.2 -->
    <script>
        window.materialVersion = "1.5.2"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">














    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            年轻人的第一个私人BGP(三) - 带入家中 | 
        
        LovelyWei&#39;s 废纸篓
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/avatar.jpg">
    <link rel="icon" href="/img/avatar.jpg">

    <meta name="format-detection" content="telephone=no">
    <meta name="description" itemprop="description" content="BGP系列也好久没更新过了,最近放假放的有点久…干了点新的东西,让家里的网络用上自己的IP.">
    <meta name="keywords" content=",Tech,Network,BGP">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta http-equiv="Cache-Control" content="no-siteapp">

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?LH0s8usgiEPzK9Nm8d0feA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        
            
                <style id="prettify_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_css","/css/prettify.min.css?zp8STOU9v89XWFEnN+6YmQ==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
                <style id="prettify_theme"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("prettify_theme","/css/prettify/tomorrow-night-eighties.min.css?2LJQzURO+Kr8r/fl/T8oMA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
            
        

    

    
        
            <link rel="stylesheet" href="/css/fontawesome.min.css">
        
    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?ezyEvm8ST5CGfpA+kFFi1g==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="LovelyWei&#39;s 废纸篓">
    <meta name="msapplication-starturl" content="https://hex.moe/p/953be679/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="LovelyWei&#39;s 废纸篓">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/avatar.jpg">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    
        
            <link rel="alternate" type="application/atom+xml" href="/atom.xml">
        
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="https://hex.moe/p/953be679/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="年轻人的第一个私人BGP(三) - 带入家中 | LovelyWei&#39;s 废纸篓">
    <meta property="og:image" content="/img/avatar.jpg">
    <meta property="og:description" content="BGP系列也好久没更新过了,最近放假放的有点久…干了点新的东西,让家里的网络用上自己的IP.">
    <meta property="og:article:tag" content="Tech"> <meta property="og:article:tag" content="Network"> <meta property="og:article:tag" content="BGP"> 

    
        <meta property="article:published_time" content="Fri Feb 28 2020 19:56:38 GMT+0800">
        <meta property="article:modified_time" content="Fri Nov 18 2022 18:19:54 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="https://hex.moe/p/953be679/index.html">
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "https://hex.moe/p/953be679/index.html",
    "headline": "年轻人的第一个私人BGP(三) - 带入家中",
    "datePublished": "Fri Feb 28 2020 19:56:38 GMT+0800",
    "dateModified": "Fri Nov 18 2022 18:19:54 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "LovelyWei",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.jpg"
        },
        "description": "A Noob."
    },
    "publisher": {
        "@type": "Organization",
        "name": "LovelyWei&#39;s 废纸篓",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/avatar.jpg"
        }
    },
    "keywords": ",Tech,Network,BGP",
    "description": "BGP系列也好久没更新过了,最近放假放的有点久…干了点新的东西,让家里的网络用上自己的IP.",
}
</script>


    

    <!-- Analytics -->
    
        <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-120647290-2', 'auto');ga('send', 'pageview');
</script>
    
    
    

    <!-- Custom Head -->
    

<meta name="generator" content="Hexo 4.2.1"></head>


    
        <body id="scheme-Isolation" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                
                    <!-- Isolation Header -->
                    <header class="header">
    <div class="header-wrapper">
        <!-- Header Copyright -->
        <div class="header-copyright">
            <div class="header-site">
                ©&nbsp;
                <script type="text/javascript">
                    var fd = new Date();
                    document.write(fd.getFullYear());
                </script>
                &nbsp;LovelyWei's 废纸篓
            </div>
            <!--
            I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright.
            It will not impact the appearance and can give developers a lot of support :)

            很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
            它不会影响美观并可以给开发者很大的支持。 :)
            -->
            <div>
                Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a>
                <br>
                Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Material</a>
            </div>
        </div>

        <!-- Header Title -->
        <span class="header-title header-item">
            <a href="/" title="LovelyWei&#39;s 废纸篓">
                LovelyWei&#39;s 废纸篓
            </a>
        </span>

        <p class="header-slogan header-item">
        
            
                A Noob.
            
        
        </p>

        <!-- Header Nav -->
        <nav class="header-nav header-item">
            <span class="header-nav-item">
                <a href="/" title="Home">
                    <span>Home</span>
                </a>
            </span>

            <!-- Pages  -->
            
                <span class="header-nav-item">
                    <a href="/tags" title="Tags">
                        <span>Tags</span>
                    </a>
                </span>
            
                <span class="header-nav-item">
                    <a href="/friends" title="Friends">
                        <span>Friends</span>
                    </a>
                </span>
            
                <span class="header-nav-item">
                    <a href="/timeline" title="TimeLine">
                        <span>TimeLine</span>
                    </a>
                </span>
            
                <span class="header-nav-item">
                    <a href="/about" title="About">
                        <span>About</span>
                    </a>
                </span>
            
            
        </nav>

        <!-- Header SNS -->
        <div class="header-item header-sns_list">
    <!-- Twitter -->
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Telegram -->
    
        <a href="https://t.me/LovelyWei" target="_blank" rel="external nofollow noopener noreferrer">
            <i class="fa fa-telegram fa-lg" aria-hidden="true"></i>
        </a>
    
</div>

    </div>
</header>

                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    

                    <!-- Post TOC -->

    



<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                


    <!-- Isolation Post Header -->
    <!-- Post thumbnail -->
    
        <!-- Post Header Info -->
        <div class="post-header_info without-thumbnail">
            <!-- Author Avatar & Name -->
            <img src="/img/avatar.jpg" class="avatar-img" width="44px" height="44px" alt="LovelyWei's avatar">
            <span class="name-span">LovelyWei</span>
        </div>

        <!-- Null Thumbnail -->
        <div class="post_thumbnail-null">
    
        </div>



                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    

    
        <div class="post-content_wrapper">
            <p class="post-title">
                年轻人的第一个私人BGP(三) - 带入家中
            </p>
            <p>BGP系列也好久没更新过了,最近放假放的有点久…干了点新的东西,让家里的网络用上自己的IP.</p>
<a id="more"></a>

<p>解决方案是 strongSwan IKEv2 VPN隧道到VPS服务器上,IKEv2 的证书使用的是Let’s encrypt的证书,域名挂在了<code>CloudFlare</code>上以便于调用api.</p>
<h2 id="配置服务器环境"><a href="#配置服务器环境" class="headerlink" title="配置服务器环境"></a>配置服务器环境</h2><p>博主这里使用了 香港阿里云的轻量VPS <code>CentOS7</code> (物理位置近+便宜) + HE.net 的BGP隧道,至于实现方案可以参考<a href="https://hex.moe/p/d6a20b99/">上一篇bgp系列的文章</a>.</p>
<p>参考上一篇文章,这里在上一篇文章处做出一点修改.</p>
<ul>
<li>首先将需要留给客户端的IP段从dummy1的IP删除,并且可以将自己的IP设为出口IP</li>
</ul>
<blockquote>
<p>之前的文章中配置并广播好了BGP但是出口ip还是 he.net 给的ip,并没有配置自己的IP为出口IP,解决这个问题其实很简单,只要将原有的<code>dummy1</code>配置好的IP删除,将IP配置到<code>sit1</code>接口上,并把默认路由的<code>src</code>配置为出口的ip即可 (多谢群友</p>
</blockquote>
<pre><code>[root@host ~]# ip addr add dev sit1 2a0f:9400:8000::1/48
[root@host ~]# ip -6 route change default dev sit1  src 2a0f:9400:8000::1  metric 1
[root@host ~]# curl ipv6.ip.sb
2a0f:9400:8000::1</code></pre><hr>
<ul>
<li><h3 id="安装并配置-acme-sh-生成证书"><a href="#安装并配置-acme-sh-生成证书" class="headerlink" title="安装并配置 acme.sh, 生成证书"></a>安装并配置 acme.sh, 生成证书</h3><ol>
<li><p>安装 <a href="http://acme.sh/" target="_blank" rel="external nofollow noopener noreferrer">acme.sh</a> ,用于自助签发TLS证书,并创建一个<code>alias</code>方便使用.</p>
<pre><code class="sh">curl  https://get.acme.sh | sh
alias acme.sh=~/.acme.sh/acme.sh</code></pre>
</li>
<li><p>获取<code>CloudFlare</code>的<a href="https://dash.cloudflare.com/profile" target="_blank" rel="external nofollow noopener noreferrer">Api</a></p>
<blockquote>
<p>至于详细的获取<code>CloudFlare Api Token</code>可以参考<a href="https://hex.moe/p/aaafb04f/">利用CloudFlare Api实现DDNS</a>.</p>
</blockquote>
</li>
<li><p>写<code>Token</code>到环境变量</p>
<pre><code class="sh">export CF_Key=&quot;sdfsdfsdfljlbjkljlkjsdfoiwje&quot;
export CF_Email=&quot;xxxx@sss.com&quot;</code></pre>
</li>
<li><p>现在,可以用命令自动创建证书了</p>
<pre><code class="sh">acme.sh --issue --dns dns_cf -d hex.moe -d vpn.hex.moe # 记得替换域名</code></pre>
</li>
<li><p>使用 <code>acme.sh --cron</code> 可以生成 cronjob 自动更新证书</p>
</li>
</ol>
<p>经过配置,应该可以在<code>/root/.acme.sh/vpn.hex.moe</code>中看到你的证书</p>
<pre><code class="sh">[root@host vpn.hex.moe]# pwd
/root/.acme.sh/vpn.hex.moe
[root@host vpn.hex.moe]# ls
ca.cer         vpn.hex.moe.cer   vpn.hex.moe.csr       vpn.hex.moe.key
fullchain.cer  vpn.hex.moe.conf  vpn.hex.moe.csr.conf</code></pre>
</li>
<li><h3 id="然后安装并配置-strongswan"><a href="#然后安装并配置-strongswan" class="headerlink" title="然后安装并配置 strongswan"></a>然后安装并配置 <code>strongswan</code></h3><ol>
<li><p>安装<code>strongswan</code></p>
<pre><code class="sh">yum install strongswan</code></pre>
</li>
<li><p>修改配置文件<code>ipsec.conf</code></p>
<blockquote>
<p>这里使用了旧版的配置文件,由于已经配置好了遂不再更变.( <del>又不是不能用</del></p>
</blockquote>
<pre><code class="sh">vim /etc/strongswan/ipsec.conf</code></pre>
<p>以下是内容:</p>
<pre><code class="conf">conn setup
uniqueids = no

conn %default
   compress = yes
   keyexchange=ike
   ike=aes256-sha256-sha1-modp2048-modp1024,3des-sha256-sha1-modp2048-modp1024!
   esp=aes256-sha256-sha1,3des-sha256-sha1!
   leftdns=8.8.8.8,8.8.4.4,2001:4860:4860::8888 # 此处是dns
   rightdns=8.8.8.8,8.8.4.4,2001:4860:4860::8888

conn ikev2
   dpdaction=clear
   dpddelay=60s
   rekey=no
   fragmentation=yes
   eap_identity=%identity

   left=%any
   leftid=&quot;vpn.hex.moe&quot; # 签发证书的域名
   leftsubnet=0.0.0.0/0,::/0
   leftauth=pubkey
   leftcert=fullchain.cer
   leftsendcert=always
   leftfirewall=yes

   right=%any
   rightid=%any
   rightsourceip=10.1.0.0/24,2a0e:b107:16::/48 # 要分配给客户端的ip,这里用了双栈
   rightauth=eap-mschapv2
   rightsendcert=never

   auto=add</code></pre>
<blockquote>
<p>还有一套是<code>swanctl.conf</code>的新版配置文件,由于博主没有配置过所以不多做介绍.<br>可参考这一位博主写的 <a href="https://m13253.blogspot.com/2018/07/strongswan-ikev2-vpn.html" target="_blank" rel="external nofollow noopener noreferrer">用 strongSwan 配一个支持 AEAD 的远程访问 IKEv2 VPN</a>.</p>
</blockquote>
</li>
<li><p>配置<code>strongswan</code>的证书<br>使用软连接方便更新<code>ln -s [源路径] [目标路径]</code> , 将<code>/root/.acme.sh/[域名]</code>中的</p>
<ul>
<li><code>fullchain.cer</code>放入<code>/etc/strongswan/ipsec.d/certs</code></li>
<li><code>[域名].key</code>放入<code>/etc/strongswan/ipsec.d/private</code></li>
<li><code>ca.cer</code>放入<code>/etc/strongswan/ipsec.d/cacerts</code></li>
</ul>
</li>
<li><p>配置<code>ipsec.secrets</code>,添加用户</p>
<pre><code class="sh"> vim /etc/strongswan/ipsec.secrets</code></pre>
<p> 以下是我写的内容:</p>
<pre><code class="secrets"> # ipsec.secrets - strongSwan IPsec secrets file
 : RSA vpn.hex.moe.key # 这里是私钥的文件名

 #这里是用户名和密码,%any表示任意用户名均可,EAP后面的为密码
 user1 %any : EAP &quot;123456&quot;</code></pre>
</li>
</ol>
</li>
<li><p>配置<code>sysctl.conf</code> , 开启Linux的内核转发</p>
<pre><code class="sh">/etc/sysctl.conf</code></pre>
<p>在后面添加开启相关转发的内容</p>
<pre><code class="conf">net.ipv4.ip_forward = 1
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv6.conf.all.forwarding=1</code></pre>
</li>
<li><p>配置iptables防火墙</p>
<pre><code class="sh">iptables -A INPUT -p ah -j ACCEPT
iptables -A INPUT -p esp -j ACCEPT
iptables -A INPUT -p udp -m udp --dport 500 -j ACCEPT
iptables -A INPUT -p udp -m udp --dport 4500 -j ACCEPT
iptables -A POSTROUTING -t nat -m policy --pol ipsec --dir out -j ACCEPT
iptables -A POSTROUTING -t nat -s 10.1.0.0/24 -o eth0 -j MASQUERADE
iptables -A FORWARD -t nat -i eth0 -m policy --pol ipsec --dir in -j ACCEPT
iptables-save
systemctl restart iptables</code></pre>
<blockquote>
<p>虽然说如果<code>ah</code>和<code>esp</code>头如果走不通的话会走<code>udp</code>协议,但是还是加上了</p>
</blockquote>
</li>
<li><p>在阿里云的防火墙中开启<code>udp500</code>和<code>udp4500</code>端口</p>
<hr>
<p>firewalld的防火墙类似,由于博主的centos默认是iptables的并没有实践过,所以这里贴出某位博主帖子里写的内容.</p>
<blockquote>
<p>允许 ‘AH’ 和 ‘ESP’ 身份验证协议和加密协议通过防火墙</p>
</blockquote>
<pre><code class="sh">firewall-cmd --zone=public --permanent --add-rich-rule=&#39;rule protocol value=&quot;esp&quot; accept&#39;
firewall-cmd --zone=public --permanent --add-rich-rule=&#39;rule protocol value=&quot;ah&quot; accept&#39;</code></pre>
<blockquote>
<p>开放 ipsec 和相关端口</p>
</blockquote>
<pre><code class="sh">firewall-cmd --zone=public --permanent --add-port=500/udp
firewall-cmd --zone=public --permanent --add-port=4500/udp
firewall-cmd --zone=public --permanent --add-service=&quot;ipsec&quot;</code></pre>
<blockquote>
<p>允许 ip 伪装</p>
</blockquote>
<pre><code class="sh">firewall-cmd --zone=public --permanent --add-masquerade</code></pre>
<blockquote>
<p>然后重新加载防火墙</p>
</blockquote>
<pre><code class="sh">firewall-cmd --reload</code></pre>
<hr>
</li>
<li><p>启动<code>strongswan</code>服务 <code>systemctl restart strongswan</code></p>
</li>
</ul>
<p>此时就能用Windows连接到IKEv2 VPN了!</p>
<h2 id="连接VPN"><a href="#连接VPN" class="headerlink" title="连接VPN"></a>连接VPN</h2><p>打开Win10的 <code>设置-&gt;网络和Internet-&gt;VPN</code> 并点击 <code>添加VPN连接</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/LovelyWei/PicGoData/20200301003025.png" alt></p>
<p>写好配置并保存.</p>
<p>然后点击 <code>状态-&gt;更改适配器选项</code> 右键 <code>VPN-&gt;属性-&gt;网络</code></p>
<p>如果需要使用IPv4和IPv6流量都走VPN隧道的话你需要稍微调整下IPv4的设置</p>
<p>点击<code>IPv4-&gt;属性-&gt;高级</code> 勾选 <code>在远程网络上使用默认网关</code>和 取消勾选 <code>自动跃点</code> 跃点数写一个相对小的数值,比如说,我写了<code>5</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/LovelyWei/PicGoData/20200301004612.png" alt></p>
<p>当然,我现在并不需要(</p>
<p>所以我将IPv4勾掉了,ipv4流量不走vpn,后来我连接上后…</p>
<p>…</p>
<blockquote>
<p>IPv6检测失败</p>
</blockquote>
<p>后面了解到,虽然IPv6中也有一个 <code>在远程网络上使用默认网关</code> 但是那个完全没有用,也不知道微软阿三程序员怎么写的,总之就是没有用,需要手动配置一下路由</p>
<p>所以,连接上VPN后,在<code>cmd</code>中敲入 <code>ipconfig</code> 查看分配到的ip</p>
<p><img src="https://cdn.jsdelivr.net/gh/LovelyWei/PicGoData/20200301005308.png" alt></p>
<p>并手动添加路由… </p>
<p><img src="https://cdn.jsdelivr.net/gh/LovelyWei/PicGoData/20200301005426.png" alt></p>
<p><code>请求的操作需要提升</code>(权限) , 好吧 ,右键左下角的 <code>Win</code> 图标, 选择 <code>Windows Powershell (管理员)</code>,用打开的shell再次手动添加路由</p>
<pre><code class="sh">route add ::/0 [分配到的IP]</code></pre>
<p>此时再去测试一下…</p>
<p><img src="https://cdn.jsdelivr.net/gh/LovelyWei/PicGoData/20200301005811.png" alt></p>
<p>终于成功了,这也太累了…</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>其实想做这个项目已经很久了,只是一直没有动力去做,刚好放假放了这么多天,游戏也玩腻了,刷各种网站也刷累了,看到了某篇 <a href="https://www.91yunbbs.com/discussion/641/drcais-noob-bgplayer-in-1hour-%E7%BB%9D%E8%B5%9E%E9%80%9F%E6%88%90%E7%8F%AD-%E9%80%83" target="_blank" rel="external nofollow noopener noreferrer">Noob BGPlayer in 1hour 绝赞速成班</a> ,就来实现自己的方式了”带入家中”了,当成功的那一刻还是很开心的…</p>
<p>最后感谢MoeQing动物园的各位dalao的答疑(</p>
<p><del>什么?你说近期啊,近期还有一篇水文</del></p>
<p>以上</p>
<hr>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://blog.itnmg.net/2018/08/28/centos-7-ikev2-vpn-strongswan/" target="_blank" rel="external nofollow noopener noreferrer">https://blog.itnmg.net/2018/08/28/centos-7-ikev2-vpn-strongswan/</a></li>
<li><a href="https://www.91yunbbs.com/discussion/641/drcais-noob-bgplayer-in-1hour-%E7%BB%9D%E8%B5%9E%E9%80%9F%E6%88%90%E7%8F%AD-%E9%80%83" target="_blank" rel="external nofollow noopener noreferrer">https://www.91yunbbs.com/discussion/641/drcais-noob-bgplayer-in-1hour-%E7%BB%9D%E8%B5%9E%E9%80%9F%E6%88%90%E7%8F%AD-%E9%80%83</a></li>
<li><a href="https://recursiveg.me/2016/12/assign-ipv6-through-ipsec-and-strongswan/" target="_blank" rel="external nofollow noopener noreferrer">https://recursiveg.me/2016/12/assign-ipv6-through-ipsec-and-strongswan/</a></li>
<li><a href="https://m13253.blogspot.com/2018/07/strongswan-ikev2-vpn.html" target="_blank" rel="external nofollow noopener noreferrer">https://m13253.blogspot.com/2018/07/strongswan-ikev2-vpn.html</a></li>
</ul>

            
                <blockquote>
                    <p>
                         
                            This blog is under a <a href="/creativecommons.html" target="_blank">CC BY-NC-SA 3.0 Unported License</a>
                        
                        <br>
                        Link to this article:  https://hex.moe/p/953be679/
                    </p>
                </blockquote>
            
        </div>
    
</div>


                
                    <!-- Paradox Post Info -->
                    
                

                <!-- Post Comments -->
                
                    
    <!-- 使用 Gitalk -->
<div id="gitalk-comment">
    <!-- Gitalk 评论框 -->
<div id="gitalk-container"></div>

<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

<script>
    var gitalk = new Gitalk({
            clientID: 'dda34f7fb2fdd05c451f',
            clientSecret: '943037abd1cb1327dff02dda54bc9094c464084b',
            repo: 'LovelyWei.github.io',
            owner: 'LovelyWei',
            admin: ['LovelyWei'],
            id: window.location.origin + window.location.pathname,
            // facebook-like distraction free mode
            distractionFreeMode: false
        })
   gitalk.render('gitalk-container')
</script>
</div>
<style>
    #gitalk-comment {
        background-color: #eee;
        padding: 2pc;
    }
</style>

                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/p/36a9de4d/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Newer
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/p/b02668d9/" id="post_nav-older" class="next-content">
            Older
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?wgjW/HuQG9JDgvPDPoRAng==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?V/53wGualMuiPM3xoetD5Q==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>









   <!-- GitTalk -->





<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('
<link rel="stylesheet" href="/css/uc.css">
');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Import prettify js  -->

    
        
            <script>lsloader.load("prettify_js","/js/prettify.min.js?WN07fivHQSMKWy7BmHBB6w==", true)</script>
        
    



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
        
            $(function() {
                $('pre').addClass('prettyprint linenums').attr('style', 'overflow:auto;');
                prettyPrint();
                })
        
    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.2 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
